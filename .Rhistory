# gene_names_vector<-input$genes_leadingedge
gene_names<-paste(gene_names_vector,collapse="|")
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[2]
phenos_choice
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[2]
phenos_choice
phenos_choice_all
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[1]
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
pvalue_drug<-0.05
qvalue_drug<-0.05
pvalue_phenotypes<-0.05
qvalue_phenotypes<-0.05
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl("STAT3",leadingEdge))%>%
select(dataset,module,ES,sig_id)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%"Classical (WILCOXONRANKSUMTEST)")%>%
select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_tbl_filtered
phenos_choice_all
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[c(83,106)]
phenos_choice
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
phenotype_direction
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[c(83,106)]
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
gene_names_vector<-c("STAT3","MYC")
# gene_names_vector<-input$genes_leadingedge
gene_names<-paste(gene_names_vector,collapse="|")
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[c(83,106)]
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
pvalue_drug<-0.05
qvalue_drug<-0.25
pvalue_phenotypes<-0.10
qvalue_phenotypes<-0.10
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%
select(dataset,module,ES,sig_id)%>%distinct()
chem_tbl_filtered
names(phenotype_direction)
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%
select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_chem_tbl<-pheno_tbl_filtered%>%
left_join(chem_tbl_filtered)%>%
mutate(direction=ES*estimate)%>%
mutate(direction=case_when(direction>0~1,
direction==0~0,
direction<0~-1,
TRUE~0))
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
selected_perts<-results_all_tbl%>%left_join(pheno_tbl)%>%left_join(chem_tbl)%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
chem_tbl_filtered_selected<-chem_tbl_filtered%>%select(dataset,module,ES,sig_id)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_chem_tbl<-pheno_tbl_filtered_selected%>%
left_join(chem_tbl_filtered_selected)%>%
mutate(direction=ES*estimate)%>%
mutate(direction=case_when(direction>0~1,
direction==0~0,
direction<0~-1,
TRUE~0))
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
selected_perts<-results_all_tbl%>%left_join(pheno_tbl_filtered)%>%left_join(chem_tbl_filtered)%>%distinct()
dim(selected_perts)
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_tbl$effect="good"
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_tbl$effect="good"
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
chem_tbl_filtered_selected<-chem_tbl_filtered%>%select(dataset,module,ES,sig_id)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_chem_tbl<-pheno_tbl_filtered_selected%>%
left_join(chem_tbl_filtered_selected)%>%
mutate(direction=ES*estimate)%>%
mutate(direction=case_when(direction>0~1,
direction==0~0,
direction<0~-1,
TRUE~0))
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
#results_tbl$effect="good"
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_tbl$effect="good"
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_tbl$effect_result<-"good"
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])
results_tbl$effect_result<-"good"
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])%>%mutate(effect_result="good")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])%>%mutate(effect_result="good")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==-phenotype_direction[i]&phenotype_direction[i]!=0)%>%mutate(effect_result="bad")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
selected_perts<-results_all_tbl%>%left_join(pheno_tbl_filtered)%>%left_join(chem_tbl_filtered)%>%distinct()
View(selected_perts)
sp1<-selected_perts%>%group_by(pert_iname)%>%summarise(freq=length(module))%>%arrange(desc(freq))
sp2<-selected_perts%>%group_by(pert_iname)%>%summarise(meanES=mean(abs(ES)))%>%arrange(desc(meanES))
sp3<-selected_perts%>%group_by(pert_iname)%>%summarise(sdES=sd(abs(ES)))%>%arrange(desc(sdES))
sp4<-selected_perts%>%group_by(pert_iname)%>%summarise(modules=paste(unique(module),collapse=","))%>%arrange(desc(modules))
sp5<-selected_perts%>%group_by(pert_iname)%>%summarise(nrUniqueModules=length(unique(module)))%>%arrange(desc(nrUniqueModules))
sp6<-selected_perts%>%left_join(chem_tbl%>%group_by(pert_iname)%>%summarise(Totalfreq=length(module)),by="pert_iname")%>%select(pert_iname,Totalfreq)%>%arrange(desc(Totalfreq))%>%distinct()
sp7<-sp1%>%left_join(sp6)%>%mutate(freq_ratio=freq/Totalfreq)%>%select(pert_iname,freq_ratio)%>%arrange(desc(freq_ratio))
sp1<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spall<-selected_perts%>%left_join(spg)%>%left_join(spb)
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spb<-selected_perts%>%filter(effect_result=="bad")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spall<-selected_perts%>%left_join(spg)%>%left_join(spb)
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spb<-selected_perts%>%filter(effect_result=="bad")%>%group_by(pert_iname)%>%summarise(freq_bad=length(module))
spgb<-selected_perts%>%left_join(spg)%>%left_join(spb)%>%mutate(freq_good=freq_good+1)%>%mutate(freq_bad=freq_bad+1)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spb<-selected_perts%>%filter(effect_result=="bad")%>%group_by(pert_iname)%>%summarise(freq_bad=length(module))
spgb<-selected_perts%>%left_join(spg)%>%left_join(spb)%>%mutate(freq_good=freq_good+1)%>%mutate(freq_bad=freq_bad+1)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
View(spgb)
#gene_names_vector<-c("STAT3","MYC")
gene_names_vector<-unique(genes_tbl$Genes)
# gene_names_vector<-input$genes_leadingedge
gene_names<-paste(gene_names_vector,collapse="|")
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[c(83,106)]
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
pvalue_drug<-0.05
qvalue_drug<-0.25
pvalue_phenotypes<-0.10
qvalue_phenotypes<-0.10
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
#gene_names_vector<-c("STAT3","MYC")
gene_names_vector<-unique(genes_tbl$Genes)[1:1000]
# gene_names_vector<-input$genes_leadingedge
gene_names<-paste(gene_names_vector,collapse="|")
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[c(83,106)]
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
pvalue_drug<-0.05
qvalue_drug<-0.25
pvalue_phenotypes<-0.10
qvalue_phenotypes<-0.10
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
chem_tbl_filtered_selected<-chem_tbl_filtered%>%select(dataset,module,ES,sig_id)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_chem_tbl<-pheno_tbl_filtered_selected%>%
left_join(chem_tbl_filtered_selected)%>%
mutate(direction=ES*estimate)%>%
mutate(direction=case_when(direction>0~1,
direction==0~0,
direction<0~-1,
TRUE~0))
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])%>%mutate(effect_result="good")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==-phenotype_direction[i]&phenotype_direction[i]!=0)%>%mutate(effect_result="bad")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
selected_perts<-results_all_tbl%>%left_join(pheno_tbl_filtered)%>%left_join(chem_tbl_filtered)%>%distinct()
dim(selected_perts)
selected_perts<-results_all_tbl%>%left_join(pheno_tbl_filtered)%>%left_join(chem_tbl_filtered)%>%distinct()
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))
spb<-selected_perts%>%filter(effect_result=="bad")%>%group_by(pert_iname)%>%summarise(freq_bad=length(module))
spgb<-selected_perts%>%left_join(spg)%>%left_join(spb)%>%mutate(freq_good=freq_good+1)%>%mutate(freq_bad=freq_bad+1)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
View(spgb)
spgb<-left_join(spg)%>%left_join(spb)%>%mutate(freq_good=freq_good+1)%>%mutate(freq_bad=freq_bad+1)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
spgb<-spg%>%left_join(spb)%>%mutate(freq_good=freq_good+1)%>%mutate(freq_bad=freq_bad+1)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
View(spgb)
library(fgsea)
library(AMARETTO)
library(shiny)
source("./helper_functions_drug_discovery.R")
## Chemical Perturbation Table
gbm_significant_sampled100K<-readRDS("./gbm_drug_significant_sampled100K.rds")
## Chemical Perturbation Table
gbm_significant_sampled100K<-readRDS("./gbm_drug_significant_sampled100K.rds")
chem_tbl<-gbm_significant_sampled100K
chem_tbl<-chem_tbl%>%mutate(module=gsub("Module-","",pathway))
## Phenotype Table
pheno_tbl<-readRDS("./GBM_phenotype_tests_all_GCO.rds")
pheno_tbl
library(shiny)
library(tidyverse)
source("./helper_functions_drug_discovery.R")
## Chemical Perturbation Table
gbm_significant_sampled100K<-readRDS("./gbm_drug_significant_sampled100K.rds")
chem_tbl<-gbm_significant_sampled100K
chem_tbl<-chem_tbl%>%mutate(module=gsub("Module-","",pathway))
## Phenotype Table
pheno_tbl<-readRDS("./GBM_phenotype_tests_all_GCO.rds")
pheno_tbl<-AMARETTO::phenotye_add_estimate_column(pheno_tbl)
pheno_tbl<-pheno_tbl%>%mutate(module=gsub("Module ","",ModuleNr))
pheno_tbl$dataset<-"TCGA_GBM"
pheno_up<-paste0(unique(pheno_tbl$Phenotypes),"&1")
pheno_down<-paste0(unique(pheno_tbl$Phenotypes),"&-1")
phenos_choice_all<-c(pheno_up,pheno_down)
## AMARETTO Table
AMARETTOinit<-readRDS("./AMARETTOinit_GBM_GCO.rds")
AMARETTOres<-readRDS("./AMARETTO_Results_GBM_GCO.rds")
genes_tbl<-AMARETTO::genes_amaretto_assignments_all(AMARETTOinit,AMARETTOres)
## DGIdb Table
#dgidb_tbl<-DGIDB_gene_drug(unique(genes_tbl$Genes))
#saveRDS(dgidb_tbl,"dgidb_tbl.rds")
dgidb_tbl<-readRDS("./dgidb_tbl.rds")
dgidb_tbl$results_summary
## Clinical Trial Table
clinical_trial_tbl<-readRDS("./clinical_trial_parsed_df.rds")
library(DBI)
#library(odbc)
library(dbplyr)
#gene_names_vector<-c("STAT3","MYC")
gene_names_vector<-unique(genes_tbl$Genes)[1:1000]
# gene_names_vector<-input$genes_leadingedge
gene_names<-paste(gene_names_vector,collapse="|")
# phenos_choice<-input$phenos_choice
phenos_choice<-phenos_choice_all[c(83,106)]
phenotype_direction<-as.numeric(unlist(map(strsplit(phenos_choice,"&"),2)))
names(phenotype_direction)<-unlist(map(strsplit(phenos_choice,"&"),1))
pvalue_drug<-0.05
qvalue_drug<-0.25
pvalue_phenotypes<-0.10
pvalue_drug<-0.05
qvalue_drug<-0.25
pvalue_phenotypes<-0.05
qvalue_phenotypes<-0.05
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
chem_tbl_filtered_selected<-chem_tbl_filtered%>%select(dataset,module,ES,sig_id)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_chem_tbl<-pheno_tbl_filtered_selected%>%
left_join(chem_tbl_filtered_selected)%>%
mutate(direction=ES*estimate)%>%
mutate(direction=case_when(direction>0~1,
direction==0~0,
direction<0~-1,
TRUE~0))
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])%>%mutate(effect_result="good")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==-phenotype_direction[i]&phenotype_direction[i]!=0)%>%mutate(effect_result="bad")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
selected_perts<-results_all_tbl%>%left_join(pheno_tbl_filtered)%>%left_join(chem_tbl_filtered)%>%distinct()
dim(selected_perts)
View(selected_perts)
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))%>%mutate(freq_good=freq_good+1)
spb<-selected_perts%>%filter(effect_result=="bad")%>%group_by(pert_iname)%>%summarise(freq_bad=length(module))%>%mutate(freq_bad=freq_bad+1)
spgb<-spg%>%left_join(spb)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
View(spgb)
gene_names_vector<-c("all")
# gene_names_vector<-input$genes_leadingedge
gene_names<-paste(gene_names_vector,collapse="|")
gene_names
if(gene_names==c("all")){
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%distinct()
}
else{
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
}
if(gene_names==c("all")){
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%distinct()
}
else{
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
}
if(gene_names==c("all")){
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%distinct()
}else{
chem_tbl_filtered<-chem_tbl%>%
filter(pval<pvalue_drug)%>%
filter(padj<qvalue_drug)%>%
filter(grepl(gene_names,leadingEdge))%>%distinct()
}
chem_tbl_filtered_selected<-chem_tbl_filtered%>%select(dataset,module,ES,sig_id)%>%distinct()
pheno_tbl_filtered<-pheno_tbl%>%
filter(p.value<pvalue_phenotypes)%>%
filter(q.value<qvalue_phenotypes)%>%
filter(Phenotypes%in%names(phenotype_direction))%>%distinct()
pheno_tbl_filtered_selected<-pheno_tbl_filtered%>%select(dataset,module,Phenotypes,estimate)%>%distinct()
pheno_chem_tbl<-pheno_tbl_filtered_selected%>%
left_join(chem_tbl_filtered_selected)%>%
mutate(direction=ES*estimate)%>%
mutate(direction=case_when(direction>0~1,
direction==0~0,
direction<0~-1,
TRUE~0))
results_all_tbl<-data.frame()
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==phenotype_direction[i])%>%mutate(effect_result="good")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
for (i in 1:length(phenotype_direction)){
results_tbl<-pheno_chem_tbl%>%
filter(Phenotypes%in%names(phenotype_direction)[i])%>%
filter(direction==-phenotype_direction[i]&phenotype_direction[i]!=0)%>%mutate(effect_result="bad")
results_all_tbl<-rbind(results_all_tbl,results_tbl)
}
selected_perts<-results_all_tbl%>%left_join(pheno_tbl_filtered)%>%left_join(chem_tbl_filtered)%>%distinct()
spg<-selected_perts%>%filter(effect_result=="good")%>%group_by(pert_iname)%>%summarise(freq_good=length(module))%>%mutate(freq_good=freq_good+1)
spb<-selected_perts%>%filter(effect_result=="bad")%>%group_by(pert_iname)%>%summarise(freq_bad=length(module))%>%mutate(freq_bad=freq_bad+1)
spgb<-spg%>%left_join(spb)%>%mutate(good_ratio=(freq_good)/(freq_good+freq_bad))%>%arrange(desc(good_ratio))%>%distinct()
View(spgb)
help("write.csv")
setwd("~/Documents/GitHub/Runs-AMARETTOs/Thomas/drug_Database")
setwd("~/Documents/GitHub")
devtools::document("CommunityAMARETTO")
devtools::document("CommunityAMARETTO")
system("R CMD build CommunityAMARETTO")
system("R CMD check CommunityAMARETTO")
devtools::document("CommunityAMARETTO")
system("R CMD build CommunityAMARETTO")
system("R CMD check CommunityAMARETTO")
a<-system("R CMD check CommunityAMARETTO")
a
a
devtools::document("CommunityAMARETTO")
a<-system("R CMD check CommunityAMARETTO")
rm(list = ls())
library(devtools)
library(roxygen2)
library(usethis)
library(revdepcheck)
source("https://install-github.me/r-lib/revdepcheck")
library(BiocCheck)
BiocManager::install("BiocCheck")
#BiocManager::install("BiocCheck")
library(BiocCheck)
library(formatR)
library(NCmisc)
install("CommunityAMARETTO")
# BioCheck PACKAGE ---------------------------------------------------
#BiocManager::install("Bioconductor/BiocCheck")
BiocCheck("CommunityAMARETTO/")
# non-devtools workflow ---------------------------------------------------
pkg <- "CommunityAMARETTO"
version <- read.dcf(paste('.',pkg,'DESCRIPTION',sep='/'))[,'Version']
version
# build
system2("R", paste0("CMD build ", pkg), stdout = "build.txt", stderr = "build.txt")
system2
# BioCheck PACKAGE ---------------------------------------------------
#BiocManager::install("Bioconductor/BiocCheck")
BiocCheck("CommunityAMARETTO/")
# BioCheck PACKAGE ---------------------------------------------------
#BiocManager::install("Bioconductor/BiocCheck")
setwd("./CommunityAMARETTO")
devtools::document()
devtools::check()
#devtools::check()
setwd("..")
BiocCheck("CommunityAMARETTO/")
.rs.restartR()
# BioCheck PACKAGE ---------------------------------------------------
#BiocManager::install("Bioconductor/BiocCheck")
setwd("./CommunityAMARETTO")
devtools::document()
devtools::check()
devtools::check()
devtools::check()
setwd("..")
BiocCheck("CommunityAMARETTO/")
# BioCheck PACKAGE ---------------------------------------------------
#BiocManager::install("Bioconductor/BiocCheck")
setwd("./CommunityAMARETTO")
devtools::document()
devtools::check()
